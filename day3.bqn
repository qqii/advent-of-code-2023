#!/usr/bin/env cbqn

# Written after day 4, because of a logical error with the first attempt. 

e1 â† âŸ¨
  "467..114.."
  "...*......"
  "..35..633."
  "......#..."
  "617*......"
  ".....+.58."
  "..592....."
  "......755."
  "...$.*...."
  ".664.598.."
âŸ©
e1 â†© â€¢FLines "inputs/day3.txt"

# From BQNcreate: Pad with a layer of fill elements on all sides
Pad â† (âŠ¢â†‘ËÂ·â‰âŸœÂ¬2+â‰¢)

GetSymbols â† {Â¬".0123456789"âˆŠËœğ•©}âŠ¸/â·âˆ˜âˆ¾
symbols â† Pad (GetSymbols e1) âˆŠËœ >e1
IsDigit â† {('0' â‰¤ ğ•©) âˆ§ (ğ•© â‰¤ '9')}
digits â† { (âŠ‘ğ•©âˆŠ'0'+â†•10) ? (ğ•©) ; (' ') }Â¨ Pad >e1 

# We need to pad these because Grow wraps the grid
parsed â† symbols â‹ˆÂ¨ digits

# Adapted from BQNcrate GoL to just sum the neighbours to 1 step propogate
# symbols
Grow â† {0<âŠ‘+Ëâ¥ŠâŒ½âŸœğ•©Â¨â‹ˆâŒœËœÂ¯1â€¿0â€¿1}
# Cull symbols where digits is 0, padding is always culled
Cull â† {
  sâ€¿d â† ğ•©
  {d=' '?0;s}â€¿d
} 
# Spread symbols left and right
Spread â† {
  s â† âŠ‘Â¨ ğ•©
  neighbourhood â† âŒ½âŸœsÂ¨â‹ˆâŒœËœÂ¯1â€¿0â€¿1
  spread â† âŠ‘0<+ËË˜ 1â†‘1â†“ neighbourhood
  spread â‹ˆ Â¨ 1âŠ‘Â¨ ğ•©
}
Harvest â† {
  sâ€¿d â† ğ•©
  s ? d ; '.' # just to see it better
} 

# Adapted BQNCrate split for digits only
SplitDigits â† {((âŠ¢-ËœÂ¬Ã—Â·+`Â»âŠ¸<)âˆ˜Â¬âˆ˜IsDigitËœâŠ”âŠ¢) ğ•©}
MaxDigitLen â† {âŒˆÂ´ â‰ Â¨ âˆ¾ SplitDigitsÂ¨ ğ•©}

# Taken from dzaima's utils 
# https://github.com/dzaima/aoc/blob/master/2023/BQN/utils.bqn
Ints â† {â€¢ParseFloatÂ¨((Â¯1+âŠ¢Ã—Â·+`Â»âŠ¸<)ğ•©âˆŠ'0'+â†•10)âŠ”ğ•©}

# We've padded this already, so it's safe to â¥Š this without worrying about
# digits on two lines joining. 
# https://mlochbaum.github.io/BQN/doc/fill.html
init â† CullÂ¨ Grow âŒ¾ (âŠ‘Â¨) parsed
fin â† HarvestÂ¨ CullÂ¨âˆ˜SpreadâŸ(1-ËœMaxDigitLen e1) init
â€¢Show âŸ¨"Part 1", +Â´ Ints â¥Š finâŸ© 

# ========== Part 2
gears â† Pad '*'= >e1

# # https://github.com/dzaima/aoc/blob/master/2023/BQN/3.bqn
# Pre-identifying the part numbers that belong 
# togther at the start makes our lives much easier as we don't
# have to try to figure that out at a cellular automata level!
part_ix â† Â¯1+(+`1âˆ¾1â€¿0â·âŠ¢)âŒ¾â¥ŠâŠ¸Ã— ' 'â‰ digits
part_n â† â€¢ParseFloatÂ¨ part_ixâŠ”digits

Moore â† {âŒ½âŸœğ•©Â¨â‹ˆâŒœËœÂ¯1â€¿0â€¿1}

# These magical functions come from Marshall, aka mlochbaum, the creator of BQN
# There's all types of higher order array wrangling
# <â‰1â‰âˆ˜>âˆ˜â¥Š # list variant, colapses internal shape information
# <â‰2â‰âŸ2> # shape preserving variant
# =âŠ¸{<â‰ğ•¨â‰âŸğ•¨>ğ•©} # generic shape preserving, in bqncrate
# Invert array of same-rank arrays, exchanging inner with outer axes
Magic â† {ğ•¨ <â‰2â‰âŸ2> ğ•©}
Exactly2 â† {
  g â† âŠ‘1â†“Ë˜1â†“ âŠ‘Â¨ ğ•©
  p â† Â¯1âŠ¸â‰ âŠ¸/ â· 1âŠ‘Â¨ â¥Š ğ•©
  gâˆ§2=â‰ p ? p ; âŸ¨âŸ©
}
Cleanup â† âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/â·âˆ˜â¥Š

p2 â† +Â´ (Ã—Â´âŠâŸœpart_n)Â¨ Cleanup Exactly2Â¨ Magic Moore gears â‹ˆÂ¨ part_ix
â€¢Show âŸ¨"Part 2", p2âŸ© 